/*******************************EAGLE EYE PROPRIETARY INFORMATION***************************************
 *                                                                                                     *
 *Purpose: Primary software for use on LoRa Transmiter. Handles incoming/outgoing radio signals,       *
 *                 stores and transmits GPS location of craft, works as backup parachute deployment    *
 *                 and becomes the crafts HQ if the mega were to fail.                                 *
 *                                                                                                     *
 *Date:      Version:        Developer:        Description:                                            *
 *2/9/17     1.0             Jared Danner      Initial Build.                                          *
 *******************************************************************************************************/

//LIBRARIES
/****ALTITUDE****/
#include <SD.h>
#include <TinyGPS.h>
#include <SoftwareSerial.h>

/****FLIGHT******/
float Alts[10];
boolean Touchdown = false;
#include <Wire.h>

//CONSTANT VARIABLES
/****PINS********/
#define RELAY1  28    //Parachute Digital Pin to IN1

/****SD CARD*****/
File EagleEyeData;    //File used to store the flight data. Data will be written/saved to this file during flight operations
#define SD_PIN 10     //CHANGE THIS TO MEGA OR FEATHER 

/****PARACHUTE***/
boolean chute_enable = false;       //Status of chute readiness.
boolean chute_deploy = false;       //Status of chute deployment.
int saftey_counter = 0;             //Saftey counter.
int PARACHUTE_ARM_HEIGHT = 9144;    //9144 m == 30,000 feet
int PARACHUTE_DEPLOY_HEIGHT = 6096; //6096m == 20,000 feet

/****COMMUNICATION****/
boolean HABET_Connection = true;  //Status for Connection to HABET.
byte IN[] = {B0000,B0001,B0010,B0011,B0100,B0101,B0110,B0111,B1000,B1001}; //Event Log from LoRa.
boolean DISPATCH_SIGNAL = true;
String NMEA = "                                                    "; //Variable for NMEA sentence.
char c;                           //To read characters coming from the GPS.
TinyGPS gps;                      //Object that the GPS information is saved to.
SoftwareSerial ss(3, 2);          //Reads GPS and is attached to the correct pins.

/****COMMAND****/
boolean COMMAND_CENTER = false;
boolean no_Response = false;

/*
 * Holds data values of Pressure, Altitude, and Temperature
 */
struct flight_data{
  float Altitude;
  float Latitude;
  float Longitude;
  float Speed;
  unsigned long Time;
};

void setup(){
  Serial.begin(115200);

  /****Parachute deployment Initialize****/
  //Set all the pins low so they do not toggle on Reset or Power on!
  digitalWrite(RELAY1, HIGH);  //Sends a LOW signal
  pinMode(RELAY1, OUTPUT);     //Sets RELAY1 as output pin.
  Serial.println("Parachute Online.");
  
  /****Initialize SD Card reader****/
  Serial.println("SD Card Online.");
  pinMode(SD_PIN, OUTPUT);
  if (!SD.begin(SD_PIN)) {
    Serial.println("initialization failed!");
    return;
  }
  Serial.println("initialization done.");

  /****Initialize I2C Comms****/
  Wire.begin(2);    //Setting the address for this board.
  Serial.println("Comms Address Set.\n\n");

  /****Initalize GPS Module****/
  ss.begin(9600);
}

void loop() {
  flight_data current = GPSData();                                  //Updates altitude using GPS.
  RADIO_Comm();                                                     //Habet communication.
  storeData(current.Altitude,current.Latitude,current.Longitude,current.Speed,current.Time); //Stores Data to SD Card.
  parachute(current.Altitude);  
  smartdelay(1000);                                                 //Delays in the GPS data collection, not at end of cycle                              
  TouchDown(current.Altitude);
}
/*
 * Checks to see if touchdown has occured.
 */
void TouchDown(float Alt){
  Alts[20] = 0;
  for(int i=19;i>0;i--){
    Alts[i] = Alts[i+1];
  }
  Alts[0] = Alt;
  float sum;
  for(int i=0;i<20;i++){
    sum += Alts[i];
  }
  float result = sum/20.0;
  if(result<Alt+5 && result>Alt-5){
    Touchdown = true;
    MEGA_Comm(Alt,DISPATCH_SIGNAL,7);
  }
}

/*
 * Radio Communication into and out of the LoRa.
 */
void RADIO_Comm(){
  
}
/*
 * Handles all parachute functions.
 */
void parachute(float Alt){
  if(!chute_enable && Alt >= PARACHUTE_ARM_HEIGHT){    //9144 m == 30,000 feet
    EagleEyeData = SD.open("FltData.txt", FILE_WRITE);
    saftey_counter++;
    if(saftey_counter >= 4){
      chute_enable = true;
      MEGA_Comm(Alt,DISPATCH_SIGNAL,1);
      Serial.print("Chute enabled at ");  
      Serial.println(Alt);
      EagleEyeData.print("Chute enabled at: ");
      EagleEyeData.println(Alt); 
    }
    else if(Alt <= PARACHUTE_ARM_HEIGHT){  //Resets saftey counter to 0
      saftey_counter = 0;
      Serial.println("Saftey reset to 0.");
      EagleEyeData.println("Saftey reset to 0.");  
    }
  }
  if(!chute_deploy && chute_enable && Alt <= PARACHUTE_DEPLOY_HEIGHT){  //6096m == 20,000 feet
    digitalWrite(RELAY1, LOW);                //This is close the circuit providing power the chute deployment system
    chute_deploy = true;
    MEGA_Comm(Alt,DISPATCH_SIGNAL,2);
    Serial.print("Chute deployed at: ");
    Serial.println(Alt);
    delay(2000);
    digitalWrite(RELAY1, HIGH);               //Run the current for 2 seconds, then open the circuit and stop the current
    EagleEyeData.print("Chute deployed at: ");
    EagleEyeData.println(Alt);
  }
  EagleEyeData.close();
}

/*
 * Handles delay for program, gives GPS appropriate time to read in GPS data.
 */
static void smartdelay(unsigned long ms){
  unsigned long start = millis();
  do 
  {
    while (ss.available())
      gps.encode(ss.read());
  }while(millis() - start < ms);
}
/*
 * Responsible for updating and recieving information directly from GPS.
 */
struct flight_data GPSData(){
  flight_data data;
  if(gps.f_altitude()==0.000000){
    Serial.println("NO SIGNAL");
    if(Fixed_Lost==0){
      MEGA_Comm(0.0,DISPATCH_SIGNAL,3);
      Fixed_Lost++;
    }
    data.Altitude = 0.0;
    data.Longitude = 0.0;
    data.Latitude = 0.0;
    data.Speed = 0.0;
  }
  else{
    Serial.println("SIGNAL");
    Fixed_Lost = 0;
    float lon, lat;
    unsigned long age;
    gps.f_get_position(&lat, &lon, &age);  //Saves latitude, longitude, and age of data.
    data.Altitude = gps.f_altitude();
    data.Longitude = lon;
    data.Latitude = lat;
    data.Speed = gps.f_speed_mps();
    unsigned long junk, junk1;
    gps.get_datetime(&junk,&data.Time,&junk1);
    
    Serial.print("Alt: ");
    Serial.println(data.Altitude,6);
    Serial.print("Lon: ");
    Serial.println(data.Longitude,6);
    Serial.print("Lat: ");
    Serial.println(data.Latitude,6);
    Serial.print("Speed: ");
    Serial.println(data.Speed,6);
    Serial.println();
  }
  return data;
}

/*
 * Used to store Data to SD card storage
 */
void storeData(float Alt, float Lon, float Lat, float Spe, unsigned long Time){
  EagleEyeData = SD.open("GPS_NMEA.txt", FILE_WRITE);
  EagleEyeData.print(Time);
  EagleEyeData.print(",");
  EagleEyeData.print(Lat);
  EagleEyeData.print(",");
  EagleEyeData.print(Lon);
  EagleEyeData.print(",");
  EagleEyeData.print(Alt);
  EagleEyeData.print(",");
  EagleEyeData.println(Spe);
  EagleEyeData.close();
}

/**
 * Handles Event Logging. Sends MEGA milestone updates/errors.
 *  LORA EVENTS
 *  0 - Chute Disabled
 *  1 - Chute Enabled
 *  2 - Chute Deployed
 *  3 - GPS Offline
 *  4 - Detached
 *  5 - Abort Detach
 *  6 - Radio Connection Lost
 *  7 - TouchDown
 */
void MEGA_Comm(float Altitude, boolean Send, int LoRa_Event){
  EagleEyeData = SD.open("EventLog.txt", FILE_WRITE);
  if(Send){
    Wire.beginTransmission(1);
    //Serial.println("Event sent to Mega");
    Wire.write(IN[LoRa_Event]);
    Wire.endTransmission();
    EagleEyeData.print(IN[LoRa_Event]);
    EagleEyeData.print(" <-Sent to Mega at ALT: ");
  }
  else{
    EagleEyeData.print(IN[LoRa_Event]);
    EagleEyeData.print(" <-Event Logged at ALT: ");
  }
  EagleEyeData.print(Altitude);
  EagleEyeData.print(" at flight TIME: ");
  EagleEyeData.close();
}
